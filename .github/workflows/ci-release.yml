name: ci-release

# Run this workflow on push events to release branches, push events for new
# semantic version tags, and all PRs. The merge_group trigger handles main
# branch validation via the merge queue, so a separate push trigger for main
# is not needed and would cause duplicate CI runs.
on:
  push:
    branches:
      - "v*"
    tags:
      - "v*"
  release:
    types: [published]
  pull_request:
  merge_group:
  workflow_dispatch:

jobs:
  lint:
    uses: ./.github/workflows/lint.yml

  markdown-linter:
    uses: ./.github/workflows/markdown-linter.yml

  build:
    uses: ./.github/workflows/build.yml

  test:
    uses: ./.github/workflows/test.yml

  rust-lumina-latency-monitor:
    uses: ./.github/workflows/rust-lumina-latency-monitor.yml

  goreleaser:
    if: github.event_name == 'release'
    uses: ./.github/workflows/goreleaser.yml
    permissions: write-all
    secrets:
      GORELEASER_ACCESS_TOKEN: ${{ secrets.GORELEASER_ACCESS_TOKEN }}
